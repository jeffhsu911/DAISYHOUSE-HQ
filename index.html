<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤é£²ç¸½éƒ¨æˆ°æƒ…åˆ†æç³»çµ± (HQ Pro - v7.4 æ ¼å¼ç›¸å®¹ç‰ˆ)</title>
    
    <!-- 0. éŒ¯èª¤æ””æˆª -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            if (msg && msg.includes('ResizeObserver')) return;
            console.error("Global Error:", msg);
            // åªæœ‰åœ¨éé æœŸçš„åš´é‡éŒ¯èª¤æ‰å½ˆçª—
            if (msg.includes("is not defined") || msg.includes("SyntaxError")) {
                alert("ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ (Line " + line + "):\n" + msg);
            }
        };
    </script>

    <!-- 1. å¼•å…¥ React å’Œ Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. å¼•å…¥ Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // åˆå§‹åŒ– Firebase
        window.FirebaseServices = {
            init: (rawConfig) => {
                try {
                    let configStr = rawConfig.trim();
                    // 1. æ¸…ç†: ç§»é™¤ const firebaseConfig = éƒ¨åˆ†
                    if (configStr.includes('=')) {
                        configStr = configStr.substring(configStr.indexOf('=') + 1).trim();
                    }
                    // 2. æ¸…ç†: ç§»é™¤çµå°¾åˆ†è™Ÿ
                    if (configStr.endsWith(';')) {
                        configStr = configStr.slice(0, -1);
                    }
                    
                    // 3. è§£æ: ä½¿ç”¨ Function å»ºæ§‹å¼ (æœ€å¯¬å®¹çš„è§£ææ–¹å¼ï¼Œæ”¯æ´ JS ç‰©ä»¶æ ¼å¼)
                    // é€™èƒ½è§£æ±º "apiKey": ... å’Œ apiKey: ... å…©ç¨®æ ¼å¼ä¸ç›¸å®¹çš„å•é¡Œ
                    const config = new Function("return " + configStr)();

                    if (!firebase.apps.length) {
                        firebase.initializeApp(config);
                    } else {
                        // å¦‚æœå·²ç¶“åˆå§‹åŒ–éï¼Œç›´æ¥å›å‚³
                        return firebase.firestore();
                    }
                    return firebase.firestore();
                } catch (e) {
                    console.error("Firebase Config Error:", e);
                    throw new Error("è¨­å®šç¢¼ç„¡æ³•è§£æã€‚è«‹ç¢ºèªæ‚¨è¤‡è£½äº†åŒ…å« { ... } çš„å®Œæ•´å…§å®¹ã€‚");
                }
            },
            // æ¸¬è©¦é€£ç·šåŠŸèƒ½
            testConnection: async (db) => {
                try {
                    if (!db) throw new Error("è³‡æ–™åº«ç‰©ä»¶ç‚ºç©º");
                    await db.collection('test_connection').doc('ping').set({
                        timestamp: new Date().toISOString(),
                        status: 'ok'
                    });
                    return { success: true, msg: "âœ… é€£ç·šæˆåŠŸï¼è³‡æ–™åº«è®€å¯«æ­£å¸¸ã€‚" };
                } catch (e) {
                    let msg = "é€£ç·šå¤±æ•—";
                    if (e.code === 'permission-denied') msg = "âŒ æ¬Šé™è¢«æ‹’çµ• (Permission Denied)ã€‚è«‹æª¢æŸ¥ Firebase Console çš„ Rules æ˜¯å¦å·²éæœŸ (éœ€è¨­ç‚º allow read, write: if true;)ã€‚";
                    else if (e.code === 'unavailable') msg = "âŒ ç¶²è·¯ç„¡æ³•é€£ç·šï¼Œæˆ–æ˜¯æ‚¨çš„ç€è¦½å™¨/é˜²ç«ç‰†é˜»æ“‹äº†é€£ç·šã€‚";
                    else msg = "âŒ éŒ¯èª¤ä»£ç¢¼: " + e.message;
                    return { success: false, msg: msg };
                }
            },
            subscribe: (db, collection, docId, callback) => {
                return db.collection(collection).doc(docId).onSnapshot((doc) => {
                    if (doc.exists) callback(doc.data());
                }, (error) => {
                    console.error("Sync Error:", error);
                });
            },
            save: async (db, collection, docId, data) => {
                await db.collection(collection).doc(docId).set(data, { merge: true });
            }
        };
    </script>

    <style type="text/tailwindcss">
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f5f5f4; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .report-card { @apply bg-white p-4 rounded-lg border border-stone-200 shadow-sm transition-all hover:shadow-md; }
        select { @apply bg-white border border-stone-300 text-stone-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-1.5; }
        .btn-primary { @apply flex items-center justify-center gap-2 bg-stone-800 text-white px-4 py-2 rounded-lg hover:bg-stone-700 transition-colors shadow-sm font-medium text-sm; }
        .btn-outline { @apply flex items-center justify-center gap-2 bg-white text-stone-600 border border-stone-300 px-4 py-2 rounded-lg hover:bg-stone-50 transition-colors shadow-sm font-medium text-sm; }
        .btn-danger-icon { @apply text-stone-300 hover:text-red-500 transition-colors p-1 rounded hover:bg-red-50; }
        .input-cell { @apply w-full text-right border border-stone-200 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 outline-none text-sm; }
        .badge { @apply px-2 py-0.5 rounded text-xs font-bold inline-block; }
        .mobile-menu-overlay { @apply fixed inset-0 bg-black/50 z-40 md:hidden; }
        .sidebar { @apply fixed md:relative w-64 h-full bg-stone-800 text-stone-200 shadow-xl z-50 transition-transform duration-300 ease-in-out; }
        .sidebar.closed { @apply -translate-x-full md:translate-x-0; }
    </style>
</head>
<body>
    <!-- è¼‰å…¥ä¸­èˆ‡éŒ¯èª¤é¡¯ç¤ºå€ -->
    <div id="loading-screen" class="flex flex-col items-center justify-center h-screen text-gray-600">
        <h2 class="text-2xl font-bold mb-4">v7.4 ç³»çµ±è¼‰å…¥ä¸­...</h2>
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mb-4"></div>
        <p class="text-sm mb-4">é¦–æ¬¡è¼‰å…¥å¯èƒ½éœ€è¦å¹¾ç§’é˜...</p>
        <button onclick="localStorage.clear(); window.location.reload();" class="px-4 py-2 bg-red-500 text-white rounded shadow hover:bg-red-600 text-sm">
            âš ï¸ é»æ­¤é‡ç½®ç³»çµ± (è‹¥å¡ä½è«‹æŒ‰æˆ‘)
        </button>
        <div id="error-box" class="mt-4 p-4 bg-red-100 text-red-700 text-xs rounded hidden max-w-lg text-left"></div>
    </div>

    <div id="root" style="display:none;"></div>

    <script type="text/babel">
        // é¡¯ç¤º Root, éš±è— Loading
        setTimeout(() => {
            const rootEl = document.getElementById('root');
            const loadEl = document.getElementById('loading-screen');
            if (rootEl && loadEl) {
                rootEl.style.display = 'block';
                loadEl.style.display = 'none';
            }
        }, 1000);

        const { useState, useMemo, useEffect } = React;

        // Icon å…ƒä»¶ (å®‰å…¨ç‰ˆ)
        const Icon = (props) => {
            const name = props.name;
            const size = props.size || 18;
            const className = props.className || "";

            const icons = {
                ChefHat: <path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z M6 17h12" />,
                Utensils: <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2 M7 2v20 M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" />,
                DollarSign: <path d="M12 1v22 M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />,
                Scale: <path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z M2 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z M7 21h10 M12 3v18 M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2" />,
                Trash2: <path d="M3 6h18 M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6 M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2 M10 11v6 M14 11v6" />,
                Plus: <path d="M5 12h14 M12 5v14" />,
                AlertTriangle: <g><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></g>,
                Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3" />,
                Upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M17 8l-5-5-5 5 M12 3v12" />,
                X: <path d="M18 6 6 18 M6 6l12 12" />,
                FileText: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></g>,
                ClipboardList: <g><rect width="8" height="4" x="8" y="2" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4" /><path d="M12 16h4" /><path d="M8 11h.01" /><path d="M8 16h.01" /></g>,
                Store: <path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-4h8v4" />,
                Calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></g>,
                Activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />,
                Box: <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />,
                RefreshCw: <g><path d="M23 4v6h-6" /><path d="M1 20v-6h6" /><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" /></g>,
                Search: <circle cx="11" cy="11" r="8" />,
                Link: <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />,
                ArrowRight: <line x1="5" y1="12" x2="19" y2="12" />,
                Radar: <g><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M12 12m-5 0a5 5 0 1 0 10 0a5 5 0 1 0 -10 0" /><path d="M12 3v18" /><path d="M3 12h18" /></g>,
                Cloud: <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" />,
                CloudOff: <g><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3" /><line x1="1" y1="1" x2="23" y2="23" /></g>,
                Menu: <g><line x1="3" y1="12" x2="21" y2="12" /><line x1="3" y1="6" x2="21" y2="6" /><line x1="3" y1="18" x2="21" y2="18" /></g>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const formatNum = (num) => (num || 0).toLocaleString();

        const parseCSVRow = (text) => {
            const result = [];
            let startValueIndex = 0;
            let insideQuote = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') { insideQuote = !insideQuote; } 
                else if (char === ',' && !insideQuote) {
                    let val = text.substring(startValueIndex, i).trim();
                    if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                    val = val.replace(/""/g, '"');
                    result.push(val);
                    startValueIndex = i + 1;
                }
            }
            let val = text.substring(startValueIndex).trim();
            if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
            val = val.replace(/""/g, '"');
            result.push(val);
            return result;
        };

        const detectCapacity = (name, unit) => {
            let capacity = 1;
            let baseUnit = unit || 'å–®ä½';
            const u = (unit || "").trim().toLowerCase();
            if (['kg', 'å…¬æ–¤', 'kilogram'].includes(u)) return { capacity: 1000, baseUnit: 'g' };
            if (['g', 'å…¬å…‹', 'gram'].includes(u)) return { capacity: 1, baseUnit: 'g' };
            if (['l', 'å…¬å‡', 'liter'].includes(u)) return { capacity: 1000, baseUnit: 'ml' };
            if (['ml', 'æ¯«å‡', 'cc'].includes(u)) return { capacity: 1, baseUnit: 'ml' };
            if (['lb', 'ç£…', 'pound'].includes(u)) return { capacity: 454, baseUnit: 'g' };
            const weightMatch = name.match(/(\d+(\.\d+)?)\s*(KG|kg|G|g|ML|ml|L|l)/i);
            if (weightMatch) {
                const val = parseFloat(weightMatch[1]);
                const wu = weightMatch[3].toLowerCase();
                if (wu === 'kg') { capacity = val * 1000; baseUnit = 'g'; }
                else if (wu === 'g') { capacity = val; baseUnit = 'g'; }
                else if (wu === 'l') { capacity = val * 1000; baseUnit = 'ml'; }
                else if (wu === 'ml') { capacity = val; baseUnit = 'ml'; }
            }
            return { capacity, baseUnit };
        };

        const DEFAULT_INGREDIENTS = [{ id: 'i1', name: "ç¯„ä¾‹: [A001] æ¼¢å ¡è‚‰æ’", unit: "ç®±", capacity: 50, baseUnit: "ç‰‡", unitCost: 25, note: "æ¯ç®±50ç‰‡" }];
        const DEFAULT_DISHES = [{ id: 'd1', name: "ç¶“å…¸èµ·å¸å ¡", price: 150, storeId: 'ALL' }];
        const DEFAULT_RECIPES = [{ dishId: 'd1', ingredientId: 'i1', amount: 1 }];
        const INITIAL_STORES = [{ id: 's1', name: 'å°åŒ—ç¸½åº—' }, { id: 's2', name: 'é«˜é›„åˆ†åº—' }];
        const INITIAL_STORE_DATA = {
            's1': { purchase: {}, purchaseAmounts: {}, purchasePrices: {}, opening: {}, closing: {}, sales: {} },
            's2': { purchase: {}, purchaseAmounts: {}, purchasePrices: {}, opening: {}, closing: {}, sales: {} }
        };
        const getCurrentMonth = () => new Date().toISOString().slice(0, 7);

        const App = () => {
            const [ingredients, setIngredients] = useState(() => JSON.parse(localStorage.getItem('hq_ingredients')) || DEFAULT_INGREDIENTS);
            const [dishes, setDishes] = useState(() => JSON.parse(localStorage.getItem('hq_dishes')) || DEFAULT_DISHES);
            const [recipes, setRecipes] = useState(() => JSON.parse(localStorage.getItem('hq_recipes')) || DEFAULT_RECIPES);
            const [stores, setStores] = useState(() => JSON.parse(localStorage.getItem('hq_stores')) || INITIAL_STORES);
            
            const [monthlyData, setMonthlyData] = useState(() => {
                try {
                    const saved = localStorage.getItem('hq_monthly_data');
                    let data = saved ? JSON.parse(saved) : null;
                    if (!data) return { [getCurrentMonth()]: INITIAL_STORE_DATA };
                    Object.keys(data).forEach(month => {
                        Object.keys(data[month]).forEach(storeId => {
                            const sData = data[month][storeId];
                            if (!sData.purchase) sData.purchase = {};
                            if (!sData.purchaseAmounts) sData.purchaseAmounts = {}; 
                            if (!sData.purchasePrices) sData.purchasePrices = {}; 
                            if (!sData.opening) sData.opening = {};
                            if (!sData.closing) sData.closing = {};
                            if (!sData.sales) sData.sales = {};
                        });
                    });
                    return data;
                } catch {
                    return { [getCurrentMonth()]: INITIAL_STORE_DATA };
                }
            });

            const [currentMonth, setCurrentMonth] = useState(getCurrentMonth());
            const [currentStoreId, setCurrentStoreId] = useState('ALL'); 
            const [activeTab, setActiveTab] = useState('boss_report');
            const [ingredientSearch, setIngredientSearch] = useState('');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            
            const [firebaseConfig, setFirebaseConfig] = useState(() => localStorage.getItem('hq_firebase_config') || '');
            const [db, setDb] = useState(null);
            const [isCloudConnected, setIsCloudConnected] = useState(false);
            const [showCloudModal, setShowCloudModal] = useState(false);

            const [showImportModal, setShowImportModal] = useState(false);
            const [importType, setImportType] = useState('erp_stock_v2'); 
            const [importText, setImportText] = useState('');
            const [importEncoding, setImportEncoding] = useState('UTF-8'); 

            // Cloud Init
            useEffect(() => {
                if (firebaseConfig && window.FirebaseServices) {
                    try {
                        const firestore = window.FirebaseServices.init(firebaseConfig);
                        setDb(firestore);
                        setIsCloudConnected(true);
                    } catch (e) { console.error("Firebase init failed", e); }
                }
            }, [firebaseConfig]);

            // Cloud Sync
            useEffect(() => {
                if (!db) return;
                const unsub1 = window.FirebaseServices.subscribe(db, 'hq_data', 'master', (data) => {
                    if (data?.ingredients) setIngredients(data.ingredients);
                    if (data?.dishes) setDishes(data.dishes);
                    if (data?.recipes) setRecipes(data.recipes);
                    if (data?.stores) setStores(data.stores);
                });
                const unsub2 = window.FirebaseServices.subscribe(db, 'hq_data', 'monthly', (data) => {
                     if (data?.data) setMonthlyData(data.data);
                });
                return () => { unsub1(); unsub2(); };
            }, [db]);

            const persistData = (type, data) => {
                if (type === 'ingredients') localStorage.setItem('hq_ingredients', JSON.stringify(data));
                if (type === 'dishes') localStorage.setItem('hq_dishes', JSON.stringify(data));
                if (type === 'recipes') localStorage.setItem('hq_recipes', JSON.stringify(data));
                if (type === 'stores') localStorage.setItem('hq_stores', JSON.stringify(data));
                if (type === 'monthly') localStorage.setItem('hq_monthly_data', JSON.stringify(data));
                
                if (db) {
                    if (type === 'monthly') window.FirebaseServices.save(db, 'hq_data', 'monthly', { data });
                    else window.FirebaseServices.save(db, 'hq_data', 'master', { [type]: data });
                }
            };

            const saveIngredients = (d) => { setIngredients(d); persistData('ingredients', d); };
            const saveDishes = (d) => { setDishes(d); persistData('dishes', d); };
            const saveRecipes = (d) => { setRecipes(d); persistData('recipes', d); };
            const saveStores = (d) => { setStores(d); persistData('stores', d); };
            const saveMonthlyData = (d) => { setMonthlyData(d); persistData('monthly', d); };

            const currentStoreData = useMemo(() => monthlyData[currentMonth] || {}, [monthlyData, currentMonth]);

            const analysis = useMemo(() => {
                let targetPurchase = {}, targetOpening = {}, targetClosing = {}, targetSales = {}, targetPurchaseAmount = {};
                let weightedCosts = {}, storeCostMap = {};

                if (currentStoreId === 'ALL') {
                    stores.forEach(store => {
                        const sData = currentStoreData[store.id] || {};
                        const safeAdd = (target, source) => {
                            Object.entries(source || {}).forEach(([id, qty]) => { target[id] = (target[id] || 0) + qty; });
                        };
                        safeAdd(targetPurchase, sData.purchase);
                        safeAdd(targetOpening, sData.opening);
                        safeAdd(targetClosing, sData.closing);
                        safeAdd(targetSales, sData.sales);
                        safeAdd(targetPurchaseAmount, sData.purchaseAmounts);
                    });
                    ingredients.forEach(ing => {
                        let totalCost = 0, totalQty = 0;
                        stores.forEach(store => {
                            const sData = currentStoreData[store.id] || {};
                            const qty = sData.purchase?.[ing.id] || 0;
                            const price = sData.purchasePrices?.[ing.id] !== undefined ? sData.purchasePrices[ing.id] : ing.unitCost;
                            const capacity = ing.capacity || 1;
                            if (qty > 0) {
                                totalCost += qty * capacity * price;
                                totalQty += qty * capacity;
                            }
                        });
                        weightedCosts[ing.id] = totalQty > 0 ? (totalCost / totalQty) : ing.unitCost; 
                    });
                } else {
                    const sData = currentStoreData[currentStoreId] || {};
                    targetPurchase = sData.purchase || {};
                    targetOpening = sData.opening || {};
                    targetClosing = sData.closing || {};
                    targetSales = sData.sales || {};
                    targetPurchaseAmount = sData.purchaseAmounts || {};
                    ingredients.forEach(ing => {
                        storeCostMap[ing.id] = sData.purchasePrices?.[ing.id] !== undefined ? sData.purchasePrices[ing.id] : ing.unitCost;
                    });
                }

                const getAppliedUnitCost = (ingId, defaultCost) => {
                    if (currentStoreId === 'ALL') return weightedCosts[ingId] !== undefined ? weightedCosts[ingId] : defaultCost;
                    return storeCostMap[ingId] !== undefined ? storeCostMap[ingId] : defaultCost;
                };

                const relevantDishes = dishes.filter(d => 
                    currentStoreId === 'ALL' || !d.storeId || d.storeId === 'ALL' || d.storeId === currentStoreId
                );

                const dishCosts = relevantDishes.map(dish => {
                    const dishRecipes = recipes.filter(r => r.dishId === dish.id);
                    let unitCost = 0;
                    dishRecipes.forEach(r => {
                        const ing = ingredients.find(i => i.id === r.ingredientId);
                        if (ing) {
                            const cost = getAppliedUnitCost(ing.id, ing.unitCost);
                            unitCost += r.amount * cost;
                        }
                    });
                    const soldQty = targetSales[dish.id] || 0;
                    const revenue = dish.price * soldQty;
                    const totalCost = unitCost * soldQty;
                    const profit = revenue - totalCost;
                    const marginRate = dish.price > 0 ? ((dish.price - unitCost) / dish.price) * 100 : 0;
                    return { ...dish, unitCost, soldQty, totalCost, revenue, profit, marginRate };
                });

                const ingredientUsage = ingredients.map(ing => {
                    const purchaseQty = targetPurchase[ing.id] || 0;
                    const openingQty = targetOpening[ing.id] || 0;
                    const closingQty = targetClosing[ing.id] || 0;
                    const purchaseAmt = targetPurchaseAmount[ing.id] || 0;
                    const capacity = ing.capacity || 1;
                    
                    const openingQtyBase = openingQty * capacity;
                    const purchaseQtyBase = purchaseQty * capacity;
                    const closingQtyBase = closingQty * capacity;
                    
                    const actualUsageQtyBase = openingQtyBase + purchaseQtyBase - closingQtyBase;
                    const appliedUnitCost = getAppliedUnitCost(ing.id, ing.unitCost);
                    
                    const actualUsageCost = actualUsageQtyBase * appliedUnitCost; 
                    const totalPurchaseCost = purchaseAmt > 0 ? purchaseAmt : (purchaseQtyBase * appliedUnitCost);

                    let theoreticalQty = 0;
                    relevantDishes.forEach(dish => {
                        const r = recipes.find(rec => rec.dishId === dish.id && rec.ingredientId === ing.id);
                        if (r) {
                            const soldQty = targetSales[dish.id] || 0;
                            theoreticalQty += r.amount * soldQty; 
                        }
                    });

                    const varianceQty = actualUsageQtyBase - theoreticalQty;
                    const varianceCost = varianceQty * appliedUnitCost;
                    const wasteRate = theoreticalQty > 0 ? (varianceQty / theoreticalQty) * 100 : 0;
                    const avgInventory = (openingQtyBase + closingQtyBase) / 2;
                    const turnoverRate = avgInventory > 0 ? (actualUsageQtyBase / avgInventory) : 0;

                    let statusText = 'æ­£å¸¸';
                    let statusColor = 'text-green-600 bg-green-50 border-green-200';
                    let advice = '';

                    if (varianceCost > 500 && wasteRate > 15) {
                        statusText = 'ğŸ”´ åš´é‡è¶…è€—'; statusColor = 'text-red-700 bg-red-50 border-red-200'; advice = 'æª¢æŸ¥å·åƒ/å ±å»¢';
                    } else if (varianceCost > 0 && wasteRate > 5) {
                        statusText = 'ğŸŸ¡ è¼•åº¦è¶…è€—'; statusColor = 'text-yellow-700 bg-yellow-50 border-yellow-200'; advice = 'åŠ å¼·æ¨™æº–åŒ–';
                    } else if (turnoverRate > 0 && turnoverRate < 1 && totalPurchaseCost > 2000) {
                        statusText = 'ğŸ”µ åº«å­˜å‘†æ»¯'; statusColor = 'text-blue-700 bg-blue-50 border-blue-200'; advice = 'æ¸›å°‘é€²è²¨';
                    }

                    return { 
                        ...ing, purchaseQty, openingQty, closingQty, purchaseAmt,
                        actualUsageQtyBase, actualUsageCost, appliedUnitCost,
                        theoreticalQty, varianceQty, varianceCost, 
                        totalPurchaseCost, wasteRate, turnoverRate, 
                        statusText, statusColor, advice 
                    };
                });

                const totalRevenue = dishCosts.reduce((acc, d) => acc + d.revenue, 0);
                const totalPurchaseCost = ingredientUsage.reduce((acc, i) => acc + (i.totalPurchaseCost || 0), 0);
                const totalActualCost = ingredientUsage.reduce((acc, i) => acc + (i.actualUsageCost || 0), 0);
                const costRatio = totalRevenue > 0 ? (totalActualCost / totalRevenue) * 100 : 0;
                const totalTheoreticalCost = dishCosts.reduce((acc, d) => acc + d.totalCost, 0);
                const theoreticalCostRatio = totalRevenue > 0 ? (totalTheoreticalCost / totalRevenue) * 100 : 0;
                const costVariance = totalActualCost - totalTheoreticalCost;
                const varianceRatio = totalRevenue > 0 ? (costVariance / totalRevenue) * 100 : 0;
                const top5Risks = [...ingredientUsage].filter(i => i.varianceCost > 0).sort((a, b) => b.varianceCost - a.varianceCost).slice(0, 5);

                let priceRadar = [];
                if (currentStoreId === 'ALL') {
                    priceRadar = ingredients.map(ing => {
                        const storePrices = stores.map(s => {
                            const price = currentStoreData[s.id]?.purchasePrices?.[ing.id];
                            return { id: s.id, name: s.name, price: price || 0 }; 
                        }).filter(p => p.price > 0);
                        if (storePrices.length < 2) return null; 
                        const minPrice = Math.min(...storePrices.map(p => p.price));
                        const details = storePrices.map(s => {
                            const diff = s.price - minPrice;
                            const diffPct = (diff / minPrice) * 100;
                            return { ...s, diff, diffPct };
                        }).sort((a, b) => b.diffPct - a.diffPct); 
                        const maxDiff = details[0].diffPct;
                        return { ing, minPrice, details, maxDiff };
                    }).filter(Boolean).sort((a, b) => b.maxDiff - a.maxDiff);
                }

                return { 
                    dishCosts, ingredientUsage, totalRevenue, totalPurchaseCost, totalActualCost, costRatio, 
                    totalTheoreticalCost, theoreticalCostRatio, costVariance, varianceRatio,
                    top5Risks, priceRadar
                };
            }, [ingredients, dishes, recipes, stores, currentStoreData, currentStoreId]);

            const updateStoreData = (storeId, type, itemId, val) => {
                const newMonthlyData = JSON.parse(JSON.stringify(monthlyData));
                if (!newMonthlyData[currentMonth]) newMonthlyData[currentMonth] = {};
                if (!newMonthlyData[currentMonth][storeId]) newMonthlyData[currentMonth][storeId] = {};
                if (!newMonthlyData[currentMonth][storeId][type]) newMonthlyData[currentMonth][storeId][type] = {};
                newMonthlyData[currentMonth][storeId][type][itemId] = parseFloat(val) || 0;
                saveMonthlyData(newMonthlyData);
            };

            const clearSection = (type) => {
                if(!confirm(`ç¢ºå®šè¦æ¸…ç©ºæœ¬æœˆ (${currentMonth}) çš„${type === 'inventory' ? 'é€²éŠ·å­˜' : 'éŠ·å”®'}æ•¸æ“šå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;
                const newMonthlyData = JSON.parse(JSON.stringify(monthlyData));
                if (!newMonthlyData[currentMonth] || !newMonthlyData[currentMonth][currentStoreId]) return;
                if (type === 'inventory') {
                    newMonthlyData[currentMonth][currentStoreId].purchase = {};
                    newMonthlyData[currentMonth][currentStoreId].opening = {};
                    newMonthlyData[currentMonth][currentStoreId].closing = {};
                    newMonthlyData[currentMonth][currentStoreId].purchasePrices = {}; 
                    newMonthlyData[currentMonth][currentStoreId].purchaseAmounts = {};
                } else if (type === 'sales') {
                    newMonthlyData[currentMonth][currentStoreId].sales = {};
                }
                saveMonthlyData(newMonthlyData);
            };

            const addStore = () => {
                const name = prompt("è«‹è¼¸å…¥æ–°é–€å¸‚åç¨±ï¼š");
                if (name) {
                    const newId = `s${Date.now()}`;
                    saveStores([...stores, { id: newId, name }]);
                    const newMonthlyData = { ...monthlyData };
                    if (!newMonthlyData[currentMonth]) newMonthlyData[currentMonth] = {};
                    newMonthlyData[currentMonth][newId] = {};
                    saveMonthlyData(newMonthlyData);
                    setCurrentStoreId(newId);
                }
            };
            const deleteStore = (id) => { if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { saveStores(stores.filter(s => s.id !== id)); setCurrentStoreId('ALL'); }};
            const deleteIngredient = (id) => { if(confirm("ç¢ºå®šåˆªé™¤æ­¤é£Ÿæï¼Ÿ")) saveIngredients(ingredients.filter(i => i.id !== id)); };
            const deleteDish = (id) => { if(confirm("ç¢ºå®šåˆªé™¤æ­¤èœå“ï¼Ÿ")) saveDishes(dishes.filter(d => d.id !== id)); };
            const updateIngredient = (id, field, val) => saveIngredients(ingredients.map(i => i.id === id ? { ...i, [field]: (field === 'name' || field === 'unit' || field === 'baseUnit' || field === 'alias' || field === 'note') ? val : parseFloat(val) || 0 } : i));
            const updateDish = (id, field, val) => saveDishes(dishes.map(d => d.id === id ? { ...d, [field]: field === 'price' ? parseFloat(val)||0 : val } : d));
            const addDish = () => saveDishes([...dishes, { id: `d${Date.now()}`, name: "æ–°èœå“", price: 0, storeId: 'ALL' }]);
            const addIngredientToDish = (dishId, ingredientId) => { if (!recipes.find(r => r.dishId === dishId && r.ingredientId === ingredientId)) saveRecipes([...recipes, { dishId, ingredientId, amount: 1 }]); };
            const updateRecipeAmount = (dishId, ingredientId, val) => { saveRecipes(recipes.map(r => (r.dishId === dishId && r.ingredientId === ingredientId) ? { ...r, amount: parseFloat(val) || 0 } : r)); };
            const removeRecipeItem = (dishId, ingredientId) => saveRecipes(recipes.filter(r => !(r.dishId === dishId && r.ingredientId === ingredientId)));
            const handleSaveCloudConfig = () => { localStorage.setItem('hq_firebase_config', firebaseConfig); setShowCloudModal(false); window.location.reload(); };
            
            // Test Connection Logic (Inside App Scope)
            const handleTestConnection = async () => {
                try {
                    const tempDb = window.FirebaseServices.init(firebaseConfig);
                    const res = await window.FirebaseServices.testConnection(tempDb);
                    if (res.success) {
                        alert(res.msg);
                        handleSaveCloudConfig();
                    } else {
                        alert("é€£ç·šæ¸¬è©¦å¤±æ•—: " + res.msg);
                    }
                } catch (e) {
                    alert("è¨­å®šç¢¼éŒ¯èª¤æˆ–åˆå§‹åŒ–å¤±æ•—: " + e.message);
                }
            };

            const openImportModal = (type) => { 
                if (currentStoreId === 'ALL' && type !== 'ingredients') { alert('è«‹å…ˆé¸æ“‡åˆ†åº—ï¼'); return; }
                setImportType(type); setImportText(''); setImportEncoding('UTF-8'); setShowImportModal(true); 
            };
            const handleFileRead = (e) => { const file = e.target.files[0]; if(!file)return; const r=new FileReader(); r.onload=(ev)=>setImportText(ev.target.result); r.readAsText(file,importEncoding); e.target.value=''; };
            
            const handleBulkImport = () => {
                if (!importText.trim()) return;
                const lines = importText.split('\n').filter(l => l.trim() !== '');
                let successCount = 0;
                let newItemCount = 0;

                if (importType === 'erp_stock_v2') {
                    let updates = { purchase: {}, closing: {} };
                    let costUpdates = {};
                    let amountUpdates = {}; 
                    let newIngredientsToAdd = [];
                    lines.forEach(line => {
                        const parts = parseCSVRow(line);
                        if (parts.length < 7) return;
                        const idStr = parts[1] || "";
                        const nameRaw = parts[2] || "";
                        const qty = parseFloat((parts[6] || "0").replace(/,/g, ''));
                        const val = parseFloat((parts[9] || "0").replace(/,/g, ''));
                        const unit = parts[8] || "å–®ä½";
                        const name = nameRaw.trim(); 
                        if (!name) return;
                        let ing = ingredients.find(i => i.name === name || i.alias === name) || newIngredientsToAdd.find(i => i.name === name);
                        if (!ing) {
                            const { capacity, baseUnit } = detectCapacity(name, unit);
                            ing = { id: `i_auto_${Date.now()}_${newItemCount}`, name: name, unit: unit, capacity: capacity, baseUnit: baseUnit, unitCost: 0, alias: '' };
                            newIngredientsToAdd.push(ing);
                            newItemCount++;
                        }
                        if (idStr.includes('IN')) {
                            updates.purchase[ing.id] = (updates.purchase[ing.id] || 0) + qty;
                            amountUpdates[ing.id] = (amountUpdates[ing.id] || 0) + val;
                        } else if (idStr.includes('OUT')) {
                            updates.purchase[ing.id] = (updates.purchase[ing.id] || 0) - qty;
                            amountUpdates[ing.id] = (amountUpdates[ing.id] || 0) - val;
                        } else if (idStr.includes('ç›¤é»')) {
                            updates.closing[ing.id] = Math.abs(qty);
                        }
                        successCount++;
                    });
                    Object.keys(amountUpdates).forEach(ingId => {
                         const totalAmount = amountUpdates[ingId];
                         const totalQty = updates.purchase[ingId];
                         const ing = ingredients.find(i => i.id === ingId) || newIngredientsToAdd.find(i => i.id === ingId);
                         if (totalAmount > 0 && totalQty > 0 && ing) {
                             const capacity = ing.capacity || 1;
                             costUpdates[ingId] = (totalAmount / totalQty) / capacity;
                         }
                    });
                    if (newIngredientsToAdd.length > 0) saveIngredients([...ingredients, ...newIngredientsToAdd]);
                    const newMonthlyData = JSON.parse(JSON.stringify(monthlyData));
                    if (!newMonthlyData[currentMonth]) newMonthlyData[currentMonth] = {};
                    if (!newMonthlyData[currentMonth][currentStoreId]) newMonthlyData[currentMonth][currentStoreId] = {};
                    const sData = newMonthlyData[currentMonth][currentStoreId];
                    if (!sData.purchase) sData.purchase = {};
                    if (!sData.closing) sData.closing = {};
                    if (!sData.purchasePrices) sData.purchasePrices = {};
                    if (!sData.purchaseAmounts) sData.purchaseAmounts = {}; 
                    Object.entries(updates.purchase).forEach(([id, qty]) => { sData.purchase[id] = (sData.purchase[id] || 0) + qty; });
                    Object.entries(updates.closing).forEach(([id, qty]) => { sData.closing[id] = qty; });
                    Object.entries(costUpdates).forEach(([id, price]) => { sData.purchasePrices[id] = price; });
                    Object.entries(amountUpdates).forEach(([id, amt]) => { sData.purchaseAmounts[id] = (sData.purchaseAmounts[id] || 0) + amt; });
                    saveMonthlyData(newMonthlyData);

                } else if (importType === 'sales') {
                    let nameIdx = -1; let qtyIdx = -1;
                    let newDishesToAdd = [];
                    let updates = {};
                    for (let i = 0; i < Math.min(lines.length, 5); i++) {
                        const parts = parseCSVRow(lines[i]);
                        parts.forEach((col, idx) => {
                             if (['åç¨±','å“å','å•†å“','Name'].some(k => col.includes(k))) nameIdx = idx;
                             if (['æ•¸é‡','éŠ·é‡','Qty','Quantity'].some(k => col.includes(k))) qtyIdx = idx;
                        });
                        if (nameIdx !== -1 && qtyIdx !== -1) break;
                    }
                    if (nameIdx === -1) { nameIdx = 1; qtyIdx = 4; }
                    lines.forEach((line) => {
                        const parts = parseCSVRow(line);
                        if (parts.length > Math.max(nameIdx, qtyIdx)) {
                            const name = parts[nameIdx].trim();
                            const qtyStr = parts[qtyIdx].replace(/,/g, '');
                            const val = parseFloat(qtyStr);
                            if (['åç¨±','å“å'].some(k => name.includes(k)) || isNaN(val)) return;
                            let dish = dishes.find(d => d.name === name) || newDishesToAdd.find(d => d.name === name);
                            if (!dish) {
                                dish = { id: `d_auto_${Date.now()}_${newItemCount}`, name: name, price: 0, storeId: 'ALL' };
                                newDishesToAdd.push(dish);
                                newItemCount++;
                            }
                            updates[dish.id] = val;
                            successCount++;
                        }
                    });
                    if (newDishesToAdd.length > 0) saveDishes([...dishes, ...newDishesToAdd]);
                    const newData = JSON.parse(JSON.stringify(monthlyData));
                    if (!newData[currentMonth]) newData[currentMonth] = {};
                    if (!newData[currentMonth][currentStoreId]) newData[currentMonth][currentStoreId] = {};
                    if (!newData[currentMonth][currentStoreId].sales) newData[currentMonth][currentStoreId].sales = {};
                    Object.entries(updates).forEach(([id, qty]) => { newData[currentMonth][currentStoreId].sales[id] = qty; });
                    saveMonthlyData(newData);
                } else if (importType === 'ingredients') {
                    const newIngredients = [];
                    lines.forEach(line => {
                        const parts = parseCSVRow(line);
                        if (parts.length >= 2 && !['åç¨±','Name'].includes(parts[0])) {
                            newIngredients.push({ id: `i_imp_${Date.now()}_${successCount}`, name: parts[0], unit: parts[1] || 'å–®ä½', unitCost: parseFloat(parts[2]) || 0, alias: '', capacity: 1, baseUnit: parts[1] || 'å–®ä½' });
                            successCount++;
                        }
                    });
                    if (newIngredients.length > 0) saveIngredients([...ingredients, ...newIngredients]);
                }
                alert(`åŒ¯å…¥å®Œæˆï¼æˆåŠŸï¼š${successCount} ç­†`);
                setShowImportModal(false);
            };

            const inputVisibleDishes = useMemo(() => dishes.filter(d => currentStoreId === 'ALL' || !d.storeId || d.storeId === 'ALL' || d.storeId === currentStoreId), [dishes, currentStoreId]);
            const filteredIngredients = useMemo(() => ingredients.filter(i => i.name.includes(ingredientSearch) || (i.alias && i.alias.includes(ingredientSearch))), [ingredients, ingredientSearch]);

            return (
                <div className="min-h-screen flex flex-col md:flex-row text-stone-800">
                    <div className="md:hidden bg-stone-900 text-white p-4 flex justify-between z-20 sticky top-0">
                        <span className="font-bold flex gap-2"><Icon name="Store" /> æˆ°æƒ…ä¸­å¿ƒ</span>
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)}><Icon name="Menu" /></button>
                    </div>

                    {isSidebarOpen && <div className="mobile-menu-overlay" onClick={() => setIsSidebarOpen(false)}></div>}

                    <div className={`sidebar bg-stone-800 text-stone-200 w-64 flex-shrink-0 flex flex-col pt-16 md:pt-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                        <div className="p-4 bg-stone-900 hidden md:flex items-center gap-2">
                            <Icon name="Store" className="text-orange-500" />
                            <h1 className="font-bold text-lg">ç¸½éƒ¨æˆ°æƒ…ä¸­å¿ƒ</h1>
                        </div>
                        <div className="px-4 py-2 border-b border-stone-700 bg-stone-800">
                            <div className="flex items-center justify-between mb-2">
                                <label className="text-xs text-stone-500 font-bold uppercase">é€£ç·šç‹€æ…‹</label>
                                {isCloudConnected ? <span className="text-xs text-green-400 font-bold flex items-center gap-1"><Icon name="Cloud" size={12}/> ç·šä¸Š</span> : <span className="text-xs text-stone-500 flex items-center gap-1"><Icon name="CloudOff" size={12}/> é›¢ç·š</span>}
                            </div>
                            <button onClick={() => setShowCloudModal(true)} className="w-full text-xs bg-stone-700 hover:bg-stone-600 text-stone-300 py-1 rounded transition-colors mb-4">è¨­å®šé›²ç«¯è³‡æ–™åº«</button>
                            <label className="text-xs text-stone-500 font-bold uppercase block mb-1">é¸æ“‡æœˆä»½</label>
                            <div className="relative"><Icon name="Calendar" size={16} className="absolute left-2 top-2.5 text-stone-400" /><input type="month" value={currentMonth} onChange={(e) => setCurrentMonth(e.target.value)} className="w-full bg-stone-700 text-white text-sm rounded pl-8 pr-2 py-2 border border-stone-600 focus:border-orange-500 outline-none" /></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1">
                             <button onClick={() => { setCurrentStoreId('ALL'); setIsSidebarOpen(false); }} className={`w-full text-left px-3 py-2 rounded-md flex items-center justify-between ${currentStoreId === 'ALL' ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-stone-700'}`}><span className="font-bold">ğŸŒ ç¸½éƒ¨åŒ¯ç¸½ (All)</span></button>
                             <div className="text-xs text-stone-500 px-2 py-1 mt-4 uppercase font-bold tracking-wider flex justify-between items-center"><span>å„é–€å¸‚æ•¸æ“š</span><button onClick={addStore} className="hover:text-white" title="æ–°å¢é–€å¸‚"><Icon name="Plus" size={14} /></button></div>
                             {stores.map(store => (
                                 <div key={store.id} className="group relative">
                                     <button onClick={() => { setCurrentStoreId(store.id); setIsSidebarOpen(false); }} className={`w-full text-left px-3 py-2 rounded-md flex items-center justify-between ${currentStoreId === store.id ? 'bg-stone-700 text-white border-l-4 border-orange-500' : 'hover:bg-stone-700 text-stone-400'}`}><span>{store.name}</span></button>
                                     {currentStoreId === store.id && <button onClick={(e) => { e.stopPropagation(); deleteStore(store.id); }} className="absolute right-2 top-2 text-stone-500 hover:text-red-400"><Icon name="Trash2" size={14} /></button>}
                                 </div>
                             ))}
                        </div>
                    </div>

                    <div className="flex-1 h-screen overflow-y-auto pt-16 md:pt-0 bg-stone-50">
                        <div className="p-4 md:p-8 max-w-6xl mx-auto space-y-6">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <h2 className="text-2xl font-bold flex items-center gap-2">{currentStoreId === 'ALL' ? 'ğŸŒ å…¨å“ç‰Œ' : stores.find(s => s.id === currentStoreId)?.name} <span className="text-sm bg-stone-200 px-2 rounded font-normal text-stone-600">{currentMonth}</span></h2>
                                </div>
                            </div>

                            <div className="flex border-b border-stone-200 overflow-x-auto">
                                {[{id: 'boss_report', label: 'ğŸ“Š æˆ°æƒ…å„€è¡¨æ¿', icon: 'ClipboardList'}, {id: 'data_input', label: 'ğŸ“ é€²éŠ·å­˜è¼¸å…¥', icon: 'FileText'}, {id: 'settings', label: 'âš™ï¸ æ­¸æˆ¶èˆ‡é…æ–¹', icon: 'ChefHat'}].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-6 py-3 border-b-2 text-sm font-medium transition-colors whitespace-nowrap ${activeTab === tab.id ? 'border-orange-500 text-orange-600' : 'border-transparent text-stone-500 hover:text-stone-700'}`}><Icon name={tab.icon} size={16} /> {tab.label}</button>
                                ))}
                            </div>

                            <div className="fade-in">
                                {activeTab === 'boss_report' && (
                                    <div className="space-y-6">
                                        {/* Price Radar (Only in ALL mode) */}
                                        {currentStoreId === 'ALL' && (
                                            <div className="bg-white rounded-xl shadow-sm border border-stone-200 p-6 border-l-4 border-l-purple-500">
                                                <h3 className="font-bold text-stone-800 mb-4 flex items-center gap-2"><Icon name="Radar" className="text-purple-600" /> æ¡è³¼æ¯”åƒ¹é›·é”</h3>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm text-left">
                                                        <thead className="bg-purple-50 text-purple-900 font-bold">
                                                            <tr>
                                                                <th className="p-3 rounded-tl-lg min-w-[150px]">æ¨™æº–é£Ÿæ</th>
                                                                <th className="p-3 text-right min-w-[100px]">æœ€ä½é€²åƒ¹</th>
                                                                {stores.map(s => <th key={s.id} className="p-3 text-right min-w-[100px]">{s.name}</th>)}
                                                                <th className="p-3 rounded-tr-lg">ç‹€æ…‹</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-purple-100">
                                                            {analysis.priceRadar.length === 0 && <tr><td colSpan={3 + stores.length} className="p-4 text-center text-stone-400">å°šç„¡æ¯”åƒ¹æ•¸æ“š</td></tr>}
                                                            {analysis.priceRadar.map((row, idx) => (
                                                                <tr key={idx} className="hover:bg-purple-50/50">
                                                                    <td className="p-3 font-medium">{row.ing.name} <span className="text-xs text-stone-400">({row.ing.baseUnit})</span></td>
                                                                    <td className="p-3 text-right font-bold text-green-600">${row.minPrice.toFixed(3)}</td>
                                                                    {stores.map(s => {
                                                                        const detail = row.details.find(d => d.id === s.id);
                                                                        if (!detail) return <td key={s.id} className="p-3 text-right text-stone-300">-</td>;
                                                                        return (
                                                                            <td key={s.id} className="p-3 text-right">
                                                                                <div className={detail.diffPct > 10 ? "text-red-600 font-bold" : "text-stone-600"}>${detail.price.toFixed(3)}</div>
                                                                                {detail.diffPct > 10 && <div className="text-[10px] text-red-400">+{detail.diffPct.toFixed(0)}%</div>}
                                                                            </td>
                                                                        );
                                                                    })}
                                                                    <td className="p-3">{row.maxDiff > 20 ? <span className="badge bg-red-100 text-red-600">åƒ¹å·®å¤§</span> : <span className="badge bg-green-100 text-green-600">æ­£å¸¸</span>}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )}
                                        {/* Cost Performance */}
                                        <div className="bg-white rounded-xl shadow-sm border border-stone-200 p-6">
                                            <h3 className="font-bold text-stone-800 mb-4 flex items-center gap-2"><Icon name="Activity" className="text-purple-500" /> æˆæœ¬æ•ˆèƒ½åˆ†æ</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                                                <div className="p-4 bg-gray-50 rounded-lg">
                                                    <div className="text-xs text-gray-500 mb-1">ç†è«–æˆæœ¬ (Standard)</div>
                                                    <div className="text-xl font-bold text-gray-800">${analysis.totalTheoreticalCost.toLocaleString()}</div>
                                                    <div className="text-xs text-blue-600 font-medium">{analysis.theoreticalCostRatio.toFixed(1)}% of Rev</div>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded-lg">
                                                    <div className="text-xs text-gray-500 mb-1">å¯¦éš›è€—ç”¨æˆæœ¬ (Actual)</div>
                                                    <div className="text-xl font-bold text-gray-800">${analysis.totalActualCost.toLocaleString()}</div>
                                                    <div className={`text-xs font-medium ${analysis.costRatio > 35 ? 'text-red-600' : 'text-green-600'}`}>{analysis.costRatio.toFixed(1)}% of Rev</div>
                                                </div>
                                                <div className="p-4 bg-gray-50 rounded-lg">
                                                    <div className="text-xs text-gray-500 mb-1">ç®¡ç†å·®ç•° (Variance)</div>
                                                    <div className={`text-xl font-bold ${analysis.costVariance > 0 ? 'text-red-600' : 'text-green-600'}`}>{analysis.costVariance > 0 ? '+' : ''}{analysis.costVariance.toLocaleString()}</div>
                                                    <div className="text-xs text-gray-500">{analysis.varianceRatio.toFixed(1)}% å·®è·</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
                                            <div className="px-6 py-4 border-b border-stone-100 bg-red-50 flex items-center gap-2"><Icon name="AlertTriangle" className="text-red-600" /><h3 className="font-bold text-red-900">ç•°å¸¸è€—ææ’è¡Œ (Top 5)</h3></div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm text-left">
                                                    <thead className="bg-red-100/50 text-red-800"><tr><th className="px-6 py-3 min-w-[120px]">é£Ÿæ</th><th className="px-6 py-3 text-right">å¯¦éš›è€—ç”¨</th><th className="px-6 py-3 text-right">ç†è«–è€—ç”¨</th><th className="px-6 py-3 text-right">æµªè²»é‡‘é¡</th><th className="px-6 py-3 text-right text-stone-500">å¹³å‡é€²åƒ¹</th><th className="px-6 py-3 text-center">åº«å­˜å‘¨è½‰ç‡</th><th className="px-6 py-3">å»ºè­°</th></tr></thead>
                                                    <tbody className="divide-y divide-red-50">
                                                        {analysis.top5Risks.map(item => (
                                                            <tr key={item.id} className="hover:bg-red-50/30">
                                                                <td className="px-6 py-4 font-bold">{item.name}</td>
                                                                <td className="px-6 py-4 text-right font-mono">{item.actualUsageQtyBase.toFixed(1)} {item.baseUnit}</td>
                                                                <td className="px-6 py-4 text-right font-mono text-stone-500">{item.theoreticalQty.toFixed(1)} {item.baseUnit}</td>
                                                                <td className="px-6 py-4 text-right font-bold text-red-600">${item.varianceCost.toLocaleString()}</td>
                                                                <td className="px-6 py-4 text-right text-xs text-stone-500">${item.appliedUnitCost.toFixed(2)}/{item.baseUnit}</td>
                                                                <td className="px-6 py-4 text-center">
                                                                    <span className={`px-2 py-1 rounded text-xs ${item.turnoverRate < 1 ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>
                                                                        {item.turnoverRate.toFixed(1)}
                                                                    </span>
                                                                </td>
                                                                <td className="px-6 py-4 text-stone-600">{item.advice}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'data_input' && (
                                    <div className="space-y-6">
                                        {currentStoreId === 'ALL' ? (
                                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-8 text-center"><Icon name="AlertTriangle" className="mx-auto text-yellow-500 mb-2" size={32} /><h3 className="text-lg font-bold text-yellow-800">ç›®å‰æ˜¯ã€Œç¸½éƒ¨åŒ¯ç¸½ã€æ¨¡å¼</h3><p className="text-yellow-700 mt-2">è«‹å¾å·¦å´é¸å–®é¸æ“‡ä¸€é–“ã€Œç‰¹å®šåˆ†åº—ã€ï¼Œæ‰èƒ½è¼¸å…¥è©²åˆ†åº—çš„æ•¸æ“šã€‚</p></div>
                                        ) : (
                                            <div className="grid grid-cols-1 gap-6">
                                                <div className="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
                                                    <div className="px-6 py-4 bg-blue-50 border-b border-blue-100 flex justify-between items-center">
                                                        <div><h3 className="font-bold text-blue-900">ğŸ“¦ é€²éŠ·å­˜æ•¸æ“šè¼¸å…¥</h3><p className="text-xs text-blue-600">æœŸåˆ + é€²è²¨ - æœŸæœ« = è€—ç”¨</p></div>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => clearSection('inventory')} className="text-stone-400 hover:text-red-500 p-2" title="æ¸…ç©ºæœ¬æœˆé€²éŠ·å­˜æ•¸æ“š"><Icon name="Trash2" size={18}/></button>
                                                            <button onClick={() => openImportModal('erp_stock_v2')} className="btn-outline text-blue-600 border-blue-200 hover:bg-blue-50"><Icon name="Upload" size={14} /> åŒ¯å…¥ ERP</button>
                                                        </div>
                                                    </div>
                                                    <div className="p-4 max-h-[60vh] overflow-y-auto">
                                                        <table className="w-full text-sm">
                                                            <thead className="bg-stone-50 text-stone-500 font-bold">
                                                                <tr>
                                                                    <th className="p-2 text-left min-w-[120px]">é£Ÿæåç¨±</th>
                                                                    <th className="p-2 text-right">å–®ä½</th>
                                                                    <th className="p-2 text-right">å–®åŒ…</th>
                                                                    <th className="p-2 text-right">é€²è²¨$</th>
                                                                    <th className="p-2 text-right">æ·¨é€²è²¨</th>
                                                                    <th className="p-2 text-right">æœŸæœ«</th>
                                                                    <th className="p-2 text-center">æ“ä½œ</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody className="divide-y divide-stone-100">
                                                                {ingredients.map(ing => {
                                                                    const sData = currentStoreData[currentStoreId] || {};
                                                                    const pur = sData.purchase?.[ing.id] || 0;
                                                                    const close = sData.closing?.[ing.id] || 0;
                                                                    const purAmt = sData.purchaseAmounts?.[ing.id] || 0;
                                                                    return (
                                                                        <tr key={ing.id} className="hover:bg-stone-50">
                                                                            <td className="p-2 font-medium">{ing.name}</td>
                                                                            <td className="p-2 text-right text-xs text-stone-500">{ing.unit}</td>
                                                                            <td className="p-2 text-right text-xs text-stone-500"><input type="number" className="w-12 text-center border rounded bg-yellow-50" value={ing.capacity || 1} onChange={(e) => updateIngredient(ing.id, 'capacity', e.target.value)} /></td>
                                                                            <td className="p-2 text-right text-xs text-stone-500 font-mono">${purAmt.toLocaleString()}</td>
                                                                            <td className="p-2"><input type="number" className="input-cell bg-blue-50/50 border-blue-200" value={pur} onChange={(e) => updateStoreData(currentStoreId, 'purchase', ing.id, e.target.value)} /></td>
                                                                            <td className="p-2"><input type="number" className="input-cell bg-green-50/50 border-green-200" value={close} onChange={(e) => updateStoreData(currentStoreId, 'closing', ing.id, e.target.value)} /></td>
                                                                            <td className="p-2 text-center"><button onClick={() => deleteIngredient(ing.id)} className="btn-danger-icon"><Icon name="Trash2" size={16}/></button></td>
                                                                        </tr>
                                                                    );
                                                                })}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                
                                                {/* Sales Section */}
                                                <div className="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
                                                    <div className="px-6 py-4 bg-green-50 border-b border-green-100 flex justify-between items-center">
                                                        <div><h3 className="font-bold text-green-900">ğŸ½ï¸ éŠ·å”®æ•¸æ“š</h3></div>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => clearSection('sales')} className="text-stone-400 hover:text-red-500 p-2" title="æ¸…ç©ºæœ¬æœˆéŠ·å”®æ•¸æ“š"><Icon name="Trash2" size={18}/></button>
                                                            <button onClick={() => openImportModal('sales')} className="btn-outline text-green-600 border-green-200 hover:bg-green-50"><Icon name="Upload" size={14} /> åŒ¯å…¥ POS</button>
                                                        </div>
                                                    </div>
                                                    <div className="p-4 space-y-2 max-h-[60vh] overflow-y-auto">
                                                        {inputVisibleDishes.map(dish => (
                                                            <div key={dish.id} className="flex justify-between items-center p-2 hover:bg-stone-50 rounded border border-transparent hover:border-stone-200">
                                                                <div className="flex-1">
                                                                    <div className="font-medium">{dish.name}</div>
                                                                    <div className="text-xs text-stone-400">${dish.price}</div>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <input type="number" className="w-24 text-right border border-stone-300 rounded px-2 py-1 focus:ring-2 focus:ring-green-500 outline-none" value={currentStoreData[currentStoreId]?.sales?.[dish.id] || 0} onChange={(e) => updateStoreData(currentStoreId, 'sales', dish.id, e.target.value)} />
                                                                    <button onClick={() => deleteDish(dish.id)} className="btn-danger-icon"><Icon name="Trash2" size={16}/></button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {activeTab === 'settings' && (
                                    <div className="space-y-6">
                                        {/* Settings UI (Simplified for brevity but functional) */}
                                        <div className="bg-white rounded-xl shadow-sm border border-stone-200 p-6">
                                            <div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg text-stone-800">ç¸½éƒ¨çµ±ä¸€é£Ÿæåº«</h3><button onClick={() => openImportModal('ingredients')} className="btn-outline"><Icon name="Upload" size={16} /> æ‰¹æ¬¡åŒ¯å…¥</button></div>
                                            <div className="space-y-2 mb-4 overflow-x-auto">
                                                <div className="grid grid-cols-12 gap-2 text-xs font-bold text-stone-500 px-1 mb-2 min-w-[800px]">
                                                    <div className="col-span-3">ç³»çµ±åç¨±</div>
                                                    <div className="col-span-1">å–®ä½</div>
                                                    <div className="col-span-2 text-center bg-yellow-50 rounded">æ›ç®—å®¹é‡</div>
                                                    <div className="col-span-1">åŸºç¤å–®ä½</div>
                                                    <div className="col-span-2 text-right">åŸºç¤å–®åƒ¹</div>
                                                    <div className="col-span-2">å‚™è¨»</div>
                                                    <div className="col-span-1 text-center">æ“ä½œ</div>
                                                </div>
                                                {ingredients.map(ing => (
                                                    <div key={ing.id} className="grid grid-cols-12 gap-2 items-center min-w-[800px] border-b pb-1 last:border-0">
                                                        <input value={ing.name} onChange={(e) => updateIngredient(ing.id, 'name', e.target.value)} className="col-span-3 border p-1 rounded font-bold" />
                                                        <input value={ing.unit} onChange={(e) => updateIngredient(ing.id, 'unit', e.target.value)} className="col-span-1 border p-1 rounded text-center" />
                                                        <input type="number" value={ing.capacity || 1} onChange={(e) => updateIngredient(ing.id, 'capacity', e.target.value)} className="col-span-2 border p-1 rounded text-center bg-yellow-50 font-bold" />
                                                        <input value={ing.baseUnit || 'å–®ä½'} onChange={(e) => updateIngredient(ing.id, 'baseUnit', e.target.value)} className="col-span-1 border p-1 rounded text-center" />
                                                        <input type="number" value={ing.unitCost} onChange={(e) => updateIngredient(ing.id, 'unitCost', e.target.value)} className="col-span-2 border p-1 rounded text-right" />
                                                        <input value={ing.note || ''} onChange={(e) => updateIngredient(ing.id, 'note', e.target.value)} className="col-span-2 border p-1 rounded text-xs" />
                                                        <div className="col-span-1 text-center"><button onClick={() => deleteIngredient(ing.id)} className="btn-danger-icon"><Icon name="Trash2" size={16}/></button></div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="bg-white rounded-xl shadow-sm border border-stone-200 p-6">
                                            <div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg text-stone-800">èœå–®èˆ‡é…æ–¹è¨­å®š</h3><button onClick={addDish} className="btn-primary bg-blue-600 hover:bg-blue-700"><Icon name="Plus" size={16} /> æ–°å¢èœå“</button></div>
                                            <div className="mb-4 flex items-center gap-2 bg-stone-100 p-2 rounded-lg">
                                                <Icon name="Search" className="text-stone-400" />
                                                <input placeholder="æœå°‹é£Ÿæä»¥æ–°å¢é…æ–¹..." className="bg-transparent outline-none w-full text-sm" value={ingredientSearch} onChange={(e) => setIngredientSearch(e.target.value)} />
                                            </div>
                                            <div className="space-y-8">
                                                {dishes.map(dish => (
                                                    <div key={dish.id} className="border-b border-stone-100 pb-6 last:border-0 last:pb-0">
                                                        <div className="grid grid-cols-12 gap-2 items-center hover:bg-stone-50 p-1 rounded mb-2">
                                                            <div className="col-span-4"><input value={dish.name} onChange={(e) => updateDish(dish.id, 'name', e.target.value)} className="w-full font-bold text-stone-800 border-none bg-transparent" /></div>
                                                            <div className="col-span-2"><input type="number" value={dish.price} onChange={(e) => updateDish(dish.id, 'price', e.target.value)} className="w-full border p-1 rounded text-sm text-right" /></div>
                                                            <div className="col-span-4"><select value={dish.storeId || 'ALL'} onChange={(e) => updateDish(dish.id, 'storeId', e.target.value)} className="text-sm p-1 border rounded w-full"><option value="ALL">ğŸŒ å…¨é–€å¸‚</option>{stores.map(s => <option key={s.id} value={s.id}>ğŸ  {s.name}</option>)}</select></div>
                                                            <div className="col-span-2 text-center"><button onClick={() => deleteDish(dish.id)} className="text-stone-400 hover:text-red-500 p-1"><Icon name="Trash2" size={16} /></button></div>
                                                        </div>
                                                        <div className="space-y-2 pl-4 border-l-2 border-stone-200 ml-2">
                                                            {recipes.filter(r => r.dishId === dish.id).map((recipe, idx) => {
                                                                const ing = ingredients.find(i => i.id === recipe.ingredientId);
                                                                if (!ing) return null;
                                                                return (
                                                                    <div key={idx} className="flex items-center gap-4 text-sm group">
                                                                        <span className="w-48 truncate font-medium text-stone-600">{ing.name}</span>
                                                                        <div className="flex items-center gap-2">
                                                                            <input type="number" className="w-20 text-right border border-stone-200 rounded px-2 py-1 focus:ring-1 focus:ring-green-500 outline-none" value={recipe.amount} onChange={(e) => updateRecipeAmount(dish.id, ing.id, e.target.value)} />
                                                                            <span className="text-stone-500 w-10">{ing.baseUnit}</span>
                                                                        </div>
                                                                        <button onClick={() => removeRecipeItem(dish.id, ing.id)} className="text-stone-300 opacity-0 group-hover:opacity-100 hover:text-red-500 transition-opacity"><Icon name="Trash2" size={14} /></button>
                                                                    </div>
                                                                );
                                                            })}
                                                            <div className="mt-3 flex items-center gap-2">
                                                                <select className="text-sm border border-stone-200 rounded px-3 py-1.5 bg-stone-50 outline-none focus:border-green-500 w-64" onChange={(e) => { if (e.target.value) { addIngredientToDish(dish.id, e.target.value); e.target.value = ''; } }}>
                                                                    <option value="">+ æ·»åŠ é£Ÿæ (å·²éæ¿¾)</option>
                                                                    {filteredIngredients.map(ing => ( <option key={ing.id} value={ing.id}>{ing.name} ({ing.alias || 'ç„¡åˆ¥å'})</option> ))}
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {showCloudModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
                                <h3 className="font-bold text-lg mb-4">è¨­å®šé›²ç«¯è³‡æ–™åº«</h3>
                                <textarea className="w-full h-32 border rounded p-2 text-xs font-mono mb-4" value={firebaseConfig} onChange={e=>setFirebaseConfig(e.target.value)} placeholder="è²¼ä¸Š Firebase Config..." />
                                <div className="flex justify-end gap-2">
                                    <button onClick={()=>setShowCloudModal(false)} className="px-4 py-2 rounded hover:bg-stone-100">å–æ¶ˆ</button>
                                    <button onClick={() => {
                                        // æ¸¬è©¦é€£ç·šé‚è¼¯
                                        try {
                                            const tempDb = window.FirebaseServices.init(firebaseConfig);
                                            window.FirebaseServices.testConnection(tempDb).then(res => {
                                                if (res.success) {
                                                    alert(res.msg);
                                                    handleSaveCloudConfig();
                                                } else {
                                                    alert("é€£ç·šæ¸¬è©¦å¤±æ•—: " + res.msg);
                                                }
                                            });
                                        } catch (e) { alert("è¨­å®šç¢¼éŒ¯èª¤: " + e.message); }
                                    }} className="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 mr-2">æ¸¬è©¦é€£ç·š</button>
                                    <button onClick={handleSaveCloudConfig} className="btn-primary">å„²å­˜ä¸¦é€£ç·š</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showImportModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                                    <h3 className="font-bold">åŒ¯å…¥è³‡æ–™</h3>
                                    <button onClick={()=>setShowImportModal(false)}><Icon name="X"/></button>
                                </div>
                                <div className="p-6 overflow-y-auto flex-1 space-y-4">
                                    <div className="flex gap-2">
                                        <label className="border rounded px-3 py-1 bg-white cursor-pointer hover:bg-stone-50"><Icon name="Upload"/> é¸æ“‡ CSV<input type="file" className="hidden" onChange={handleFileRead}/></label>
                                        <select className="border rounded px-2" value={importEncoding} onChange={e=>setImportEncoding(e.target.value)}><option value="UTF-8">UTF-8</option><option value="Big5">Big5</option></select>
                                    </div>
                                    <div className="mb-2">
                                         <span className="text-sm font-bold text-stone-600">é¸æ“‡åŒ¯å…¥é¡å‹ï¼š</span>
                                         <div className="flex gap-2 mt-1">
                                             <button onClick={() => setImportType('erp_stock_v2')} className={`px-3 py-1 rounded text-xs ${importType === 'erp_stock_v2' ? 'bg-blue-600 text-white' : 'bg-stone-100 text-stone-500'}`}>ERP åº«å­˜ä¼°å€¼è¡¨</button>
                                             <button onClick={() => setImportType('sales')} className={`px-3 py-1 rounded text-xs ${importType === 'sales' ? 'bg-green-600 text-white' : 'bg-stone-100 text-stone-500'}`}>POS éŠ·å”®å ±è¡¨</button>
                                             <button onClick={() => setImportType('ingredients')} className={`px-3 py-1 rounded text-xs ${importType === 'ingredients' ? 'bg-gray-600 text-white' : 'bg-stone-100 text-stone-500'}`}>ç´”é£Ÿææ¸…å–®</button>
                                         </div>
                                    </div>
                                    <textarea className="w-full h-64 border rounded p-4 font-mono text-sm" value={importText} onChange={e=>setImportText(e.target.value)} />
                                </div>
                                <div className="px-6 py-4 bg-gray-50 border-t flex justify-end gap-2">
                                    <button onClick={()=>setShowImportModal(false)} className="px-4 py-2 rounded hover:bg-stone-200">å–æ¶ˆ</button>
                                    <button onClick={handleBulkImport} className="btn-primary">ç¢ºèªåŒ¯å…¥</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>